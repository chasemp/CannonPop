<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <meta name="theme-color" content="#2c1810" />
    <meta name="description" content="BustAGroove Settings - Customize your game experience" />
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json" />
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="BustAGroove Settings" />
    
    <!-- Mobile-first CSS with cache busting -->
    <link rel="stylesheet" href="./css/styles.css?v=v202509270014" />
    
    <title>BustAGroove Settings</title>
  </head>
  <body>
    <div class="app-container">
      <!-- Header with Back Button -->
      <header class="header">
        <div class="logo-container">
          <button class="btn btn-secondary" onclick="window.history.back()" style="margin-right: 1rem;">
            ‚Üê Back
          </button>
          <div class="app-logo">‚öôÔ∏è</div>
          <h1>Settings</h1>
        </div>
      </header>
      
      <!-- Settings Content -->
      <main class="main-content">
        <div class="settings-container">
          <h2>Game Settings</h2>
          
          <!-- Audio Settings -->
          <div class="settings-section">
            <h3>üîä Audio</h3>
            <div class="settings-grid">
              <div class="setting-item">
                <label>
                  <input type="checkbox" id="sound-effects" checked>
                  <span>Sound Effects</span>
                </label>
              </div>
              <div class="setting-item">
                <label>
                  <input type="checkbox" id="background-music" checked>
                  <span>Background Music</span>
                </label>
              </div>
              <div class="setting-item">
                <label for="master-volume">
                  Master Volume: <span id="volume-display">70%</span>
                </label>
                <input type="range" id="master-volume" min="0" max="100" value="70">
              </div>
            </div>
          </div>
          
          <!-- Gameplay Settings -->
          <div class="settings-section">
            <h3>üéÆ Gameplay</h3>
            <div class="settings-grid">
              <div class="setting-item">
                <label for="difficulty">
                  Difficulty:
                </label>
                <select id="difficulty">
                  <option value="easy">Easy</option>
                  <option value="normal" selected>Normal</option>
                  <option value="hard">Hard</option>
                </select>
              </div>
              <div class="setting-item">
                <label>
                  <input type="checkbox" id="show-aiming-line" checked>
                  <span>Show Aiming Line</span>
                </label>
              </div>
              <div class="setting-item">
                <label>
                  <input type="checkbox" id="haptic-feedback" checked>
                  <span>Haptic Feedback</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Analytics Dashboard -->
          <div class="settings-section">
            <h3>üìä Analytics</h3>
            <div class="settings-grid">
              <div class="setting-item">
                <button class="btn btn-secondary" id="view-analytics">
                  View Game Stats
                </button>
              </div>
              <div class="setting-item">
                <button class="btn btn-secondary" id="export-analytics">
                  Export Analytics
                </button>
              </div>
              <div class="setting-item">
                <button class="btn btn-secondary" id="clear-analytics">
                  Clear Analytics
                </button>
              </div>
            </div>
            <div id="analytics-display" class="analytics-display" style="display: none;">
              <h4>Game Performance</h4>
              <div id="performance-stats"></div>
              <h4>Game Statistics</h4>
              <div id="game-stats"></div>
            </div>
          </div>
          
          <!-- Performance Dashboard -->
          <div class="settings-section">
            <h3>‚ö° Performance Dashboard</h3>
            <div class="performance-metrics" id="performance-metrics">
              <div class="metric">
                <span class="metric-label">FPS:</span>
                <span class="metric-value" id="fps-value">--</span>
              </div>
              <div class="metric">
                <span class="metric-label">Memory:</span>
                <span class="metric-value" id="memory-value">--</span>
              </div>
              <div class="metric">
                <span class="metric-label">Quality:</span>
                <span class="metric-value" id="quality-value">--</span>
              </div>
              <div class="metric">
                <span class="metric-label">Score:</span>
                <span class="metric-value" id="score-value">--</span>
              </div>
            </div>
            <div class="performance-actions">
              <button class="btn btn-secondary" onclick="showPerformanceDetails()">Performance Details</button>
              <button class="btn btn-secondary" onclick="exportPerformanceData()">Export Performance</button>
              <button class="btn btn-primary" onclick="optimizePerformance()">Optimize Now</button>
            </div>
          </div>
          
          <!-- Action Buttons -->
          <div class="settings-actions">
            <button class="btn btn-primary" id="save-settings">
              Save Settings
            </button>
            <button class="btn btn-secondary" onclick="window.history.back()">
              Cancel
            </button>
          </div>
        </div>
      </main>
    </div>
    
    <script>
      // Simple settings management
      class SettingsManager {
        constructor() {
          this.settings = this.loadSettings();
          this.initializeUI();
          this.setupEventListeners();
        }
        
        loadSettings() {
          const defaultSettings = {
            soundEffects: true,
            backgroundMusic: true,
            masterVolume: 70,
            difficulty: 'normal',
            showAimingLine: true,
            hapticFeedback: true
          };
          
          try {
            const saved = localStorage.getItem('bustagroove_settings');
            return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
          } catch (error) {
            console.error('Failed to load settings:', error);
            return defaultSettings;
          }
        }
        
        saveSettings() {
          try {
            localStorage.setItem('bustagroove_settings', JSON.stringify(this.settings));
            console.log('Settings saved:', this.settings);
            alert('Settings saved successfully!');
            
            // Notify game if it's running
            if (window.parent && window.parent !== window) {
              window.parent.postMessage({
                event: 'settingsUpdated',
                settings: this.settings
              }, '*');
            }
          } catch (error) {
            console.error('Failed to save settings:', error);
            alert('Failed to save settings');
          }
        }
        
        initializeUI() {
          document.getElementById('sound-effects').checked = this.settings.soundEffects;
          document.getElementById('background-music').checked = this.settings.backgroundMusic;
          document.getElementById('master-volume').value = this.settings.masterVolume;
          document.getElementById('difficulty').value = this.settings.difficulty;
          document.getElementById('show-aiming-line').checked = this.settings.showAimingLine;
          document.getElementById('haptic-feedback').checked = this.settings.hapticFeedback;
          this.updateVolumeDisplay();
        }
        
        setupEventListeners() {
          const volumeSlider = document.getElementById('master-volume');
          volumeSlider.addEventListener('input', (e) => {
            this.settings.masterVolume = parseInt(e.target.value);
            this.updateVolumeDisplay();
          });
          
          const checkboxes = document.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
              const settingName = e.target.id.replace(/-/g, '');
              this.settings[settingName] = e.target.checked;
            });
          });
          
          const selects = document.querySelectorAll('select');
          selects.forEach(select => {
            select.addEventListener('change', (e) => {
              const settingName = e.target.id;
              this.settings[settingName] = e.target.value;
            });
          });
          
          document.getElementById('save-settings').addEventListener('click', () => {
            this.saveSettings();
          });
          
          // Analytics buttons
          document.getElementById('view-analytics').addEventListener('click', () => {
            this.showAnalytics();
          });
          
          document.getElementById('export-analytics').addEventListener('click', () => {
            this.exportAnalytics();
          });
          
          document.getElementById('clear-analytics').addEventListener('click', () => {
            this.clearAnalytics();
          });
        }
        
        updateVolumeDisplay() {
          document.getElementById('volume-display').textContent = `${this.settings.masterVolume}%`;
        }
        
        showAnalytics() {
          const display = document.getElementById('analytics-display');
          const performanceStats = document.getElementById('performance-stats');
          const gameStats = document.getElementById('game-stats');
          
          // Get analytics data from localStorage
          const storedEvents = JSON.parse(localStorage.getItem('cannonpop_analytics') || '[]');
          
          if (storedEvents.length === 0) {
            performanceStats.innerHTML = '<p>No analytics data available</p>';
            gameStats.innerHTML = '<p>No game statistics available</p>';
          } else {
            // Calculate performance metrics
            const performanceEvents = storedEvents.filter(e => e.event === 'low_fps' || e.event === 'high_memory_usage');
            const gameEvents = storedEvents.filter(e => e.event.includes('game_') || e.event.includes('bubble_'));
            
            // Display performance stats
            performanceStats.innerHTML = `
              <p><strong>Total Events:</strong> ${storedEvents.length}</p>
              <p><strong>Performance Issues:</strong> ${performanceEvents.length}</p>
              <p><strong>Game Events:</strong> ${gameEvents.length}</p>
              <p><strong>Last Session:</strong> ${new Date(storedEvents[storedEvents.length - 1]?.timestamp).toLocaleString()}</p>
            `;
            
            // Display game stats
            const shotsFired = gameEvents.filter(e => e.event === 'bubble_shot').length;
            const bubblesCleared = gameEvents.filter(e => e.event === 'bubble_cleared').length;
            const specialBubbles = gameEvents.filter(e => e.event === 'special_bubble_used').length;
            
            gameStats.innerHTML = `
              <p><strong>Shots Fired:</strong> ${shotsFired}</p>
              <p><strong>Bubbles Cleared:</strong> ${bubblesCleared}</p>
              <p><strong>Special Bubbles Used:</strong> ${specialBubbles}</p>
              <p><strong>Accuracy:</strong> ${shotsFired > 0 ? Math.round((bubblesCleared / shotsFired) * 100) : 0}%</p>
            `;
          }
          
          display.style.display = display.style.display === 'none' ? 'block' : 'none';
        }
        
        exportAnalytics() {
          try {
            const storedEvents = JSON.parse(localStorage.getItem('cannonpop_analytics') || '[]');
            const dataStr = JSON.stringify(storedEvents, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `cannonpop-analytics-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            this.showNotification('Analytics exported successfully!', 'success');
          } catch (error) {
            console.error('Export failed:', error);
            this.showNotification('Export failed', 'error');
          }
        }
        
        clearAnalytics() {
          if (confirm('Are you sure you want to clear all analytics data?')) {
            try {
              localStorage.removeItem('cannonpop_analytics');
              this.showNotification('Analytics data cleared!', 'success');
              
              // Hide analytics display if open
              document.getElementById('analytics-display').style.display = 'none';
            } catch (error) {
              console.error('Clear failed:', error);
              this.showNotification('Clear failed', 'error');
            }
          }
        }
      }
      
      // Performance Dashboard Functions
      function updatePerformanceMetrics() {
        if (window.performanceManager) {
          const dashboard = window.performanceManager.getPerformanceDashboard();
          
          document.getElementById('fps-value').textContent = dashboard.current.fps;
          document.getElementById('memory-value').textContent = dashboard.current.memory.toFixed(1) + ' MB';
          document.getElementById('quality-value').textContent = dashboard.current.quality.toUpperCase();
          document.getElementById('score-value').textContent = dashboard.score.overall + '%';
        }
      }
      
      function showPerformanceDetails() {
        if (window.performanceManager) {
          const dashboard = window.performanceManager.getPerformanceDashboard();
          
          const details = `
            <h4>Performance Details</h4>
            <div class="performance-details">
              <div class="detail-row">
                <span>Current FPS:</span>
                <span>${dashboard.current.fps}</span>
              </div>
              <div class="detail-row">
                <span>Average FPS:</span>
                <span>${dashboard.average.fps}</span>
              </div>
              <div class="detail-row">
                <span>Memory Usage:</span>
                <span>${dashboard.current.memory.toFixed(1)} MB</span>
              </div>
              <div class="detail-row">
                <span>Frame Time:</span>
                <span>${dashboard.current.frameTime.toFixed(2)} ms</span>
              </div>
              <div class="detail-row">
                <span>Quality Level:</span>
                <span>${dashboard.current.quality.toUpperCase()}</span>
              </div>
              <div class="detail-row">
                <span>Stability Score:</span>
                <span>${dashboard.average.stability}%</span>
              </div>
              <div class="detail-row">
                <span>Overall Score:</span>
                <span>${dashboard.score.overall}%</span>
              </div>
            </div>
          `;
          
          document.getElementById('analytics-display').innerHTML = details;
          document.getElementById('analytics-display').style.display = 'block';
        }
      }
      
      function exportPerformanceData() {
        if (window.performanceManager) {
          window.performanceManager.exportPerformanceData();
        }
      }
      
      function optimizePerformance() {
        if (window.performanceManager) {
          window.performanceManager.performMemoryCleanup();
          window.performanceManager.optimizeRendering();
          alert('Performance optimization applied!');
          updatePerformanceMetrics();
        }
      }
      
      document.addEventListener('DOMContentLoaded', () => {
        new SettingsManager();
        
        // Update performance metrics every 2 seconds
        setInterval(updatePerformanceMetrics, 2000);
      });
    </script>
    
    <style>
      .settings-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem;
      }
      
      .settings-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .settings-section h3 {
        margin: 0 0 1rem 0;
        color: var(--accent-color, #ff6b35);
        font-size: 1.2rem;
      }
      
      .settings-grid {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      
      .setting-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
      }
      
      .setting-item label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        flex: 1;
      }
      
      .setting-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--accent-color, #ff6b35);
      }
      
      .setting-item input[type="range"] {
        flex: 1;
        max-width: 200px;
        accent-color: var(--accent-color, #ff6b35);
      }
      
      .setting-item select {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 6px;
        padding: 8px 12px;
        color: var(--text-color, #f5f1e8);
        min-width: 120px;
      }
      
      .settings-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
      }
      
      .analytics-display {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .analytics-display h4 {
        margin: 0 0 0.5rem 0;
        color: var(--accent-color, #ff6b35);
        font-size: 1rem;
      }
      
      .analytics-display p {
        margin: 0.25rem 0;
        font-size: 14px;
      }
      
      /* Performance Dashboard Styles */
      .performance-metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
        margin: 1rem 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .metric {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      
      .metric-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
      }
      
      .metric-value {
        font-size: 18px;
        font-weight: bold;
        color: var(--primary-color);
      }
      
      .performance-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-top: 1rem;
      }
      
      .performance-details {
        margin-top: 1rem;
      }
      
      .detail-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .detail-row:last-child {
        border-bottom: none;
      }
      
      .detail-row span:first-child {
        color: var(--text-secondary);
      }
      
      .detail-row span:last-child {
        color: var(--primary-color);
        font-weight: bold;
      }
      
      @media (max-width: 480px) {
        .settings-container {
          padding: 1rem;
        }
        
        .setting-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }
        
        .settings-actions {
          flex-direction: column;
        }
      }
    </style>
  </body>
</html>