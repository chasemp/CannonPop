const G=()=>window.location.hostname==="localhost"||window.location.hostname.includes("127.0.0.1")||localStorage.getItem("debug")==="true",d={log:(...e)=>{G()&&console.log("[GAME]",...e)},warn:(...e)=>{G()&&console.warn("[GAME]",...e)},error:(...e)=>{console.error("[GAME]",...e),window.gameErrorCount===void 0&&(window.gameErrorCount=0),window.gameErrorCount++},info:(e,...n)=>{G()&&console.log("[GAME]",e,...n)}},P={maxRetries:3,retryCount:0,handleError(e,n,i){d.error(`‚ùå Error in ${n}:`,e),this.retryCount<this.maxRetries&&i?(this.retryCount++,d.warn(`üîÑ Retrying ${n} (attempt ${this.retryCount}/${this.maxRetries})`),setTimeout(()=>{try{i()}catch(o){this.handleError(o,n,i)}},1e3*this.retryCount)):(d.error(`üí• Max retries exceeded for ${n}`),this.showErrorToUser(n,e))},showErrorToUser(e,n){const i=document.getElementById("game-container");i&&(i.innerHTML=`
        <div style="color: #f5f1e8; text-align: center; padding: 20px; background: rgba(0,0,0,0.8); border-radius: 8px;">
          <h3>‚ö†Ô∏è Game Error</h3>
          <p>Something went wrong: ${e}</p>
          <button onclick="location.reload()" style="padding: 8px 16px; margin-top: 10px; background: #8d6e63; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reload Game
          </button>
        </div>
      `)},reset(){this.retryCount=0}},h={type:Phaser.AUTO,width:400,height:600,parent:"game-container",backgroundColor:"#fff5e1",physics:{default:"arcade",arcade:{gravity:{y:0},debug:!1}},scene:{preload:H,create:W,update:q},scale:{mode:Phaser.Scale.FIT,autoCenter:Phaser.Scale.CENTER_BOTH,width:400,height:600,min:{width:320,height:480},max:{width:500,height:800}},input:{activePointers:3,touch:{capture:!0}},render:{antialias:!1,pixelArt:!1,roundPixels:!0}};let M,t={currentState:"MENU",score:0,level:1,shotsFired:0,shotsUntilCeilingDrop:6,canShoot:!1,lastStateChangeTime:0,powerUps:{bomb:0,rainbow:0,laser:0},specialBubbles:[],activePowerUp:null,grid:[],currentBubble:null,nextBubble:null,launcher:null,cannonBarrel:null,bubbleGroup:null,isAiming:!1,aimingLine:null,currentAimAngle:0,scoreText:null,levelText:null,shotsText:null,stateText:null,powerUpUI:null,menuContainer:null,gameOverContainer:null,bubblesCleared:0,totalBubbles:0,ceilingRow:0,startTime:null,lastShotTime:null};const s={MENU:"MENU",PLAYING:"PLAYING",PAUSED:"PAUSED",GAME_OVER:"GAME_OVER",LEVEL_COMPLETE:"LEVEL_COMPLETE",LOADING:"LOADING"},p=8,y=12,m=20,A=["blue","red","yellow","cream","green","purple"];function H(){d.log("üéØ Phaser preload() called"),d.log("üîç Scale dimensions:",this.scale.width,"x",this.scale.height),this.load.image("splash-logo","/images/cannon_with_text.png"),A.forEach(e=>{fe.call(this,e)}),d.log("üéÆ Game assets loaded")}function W(){d.log("üöÄ Initializing CannonPop game..."),t.bubbleGroup=this.physics.add.group(),T.call(this),Z.call(this),t.aimingLine=this.add.graphics(),t.aimingLine.setDepth(15),ee.call(this),b.call(this,s.MENU),window.handleGameLoaded&&window.handleGameLoaded(),d.log("‚úÖ CannonPop game initialized")}function q(){switch(t.currentState){case s.PLAYING:t.currentBubble&&ke.call(this),Me.call(this),Ae.call(this);break}}function b(e,n={}){try{const i=t.currentState;if(d.log(`üîÑ State change: ${i} ‚Üí ${e}`),!J(i,e)){d.warn(`‚ö†Ô∏è Invalid state transition: ${i} ‚Üí ${e}`);return}Q.call(this,i),t.currentState=e,t.lastStateChangeTime=Date.now(),t.canShoot=!1,e===s.PLAYING&&setTimeout(()=>{t.canShoot=!0},300),B.call(this,e,n),window.handleScoreUpdate&&window.handleScoreUpdate({event:"stateChanged",oldState:i,newState:e,data:n})}catch(i){P.handleError(i,"changeGameState",()=>{t.currentState=s.MENU,B.call(this,s.MENU)})}}function J(e,n){const i={[s.MENU]:[s.PLAYING,s.LOADING],[s.LOADING]:[s.MENU,s.PLAYING],[s.PLAYING]:[s.PAUSED,s.GAME_OVER,s.LEVEL_COMPLETE],[s.PAUSED]:[s.PLAYING,s.MENU],[s.GAME_OVER]:[s.MENU,s.PLAYING],[s.LEVEL_COMPLETE]:[s.PLAYING,s.MENU]};return i[e]&&i[e].includes(n)}function j(){try{this.tweens&&this.tweens.killAll(),t.bubbleGroup&&t.bubbleGroup.clear(!0,!0),t.menuContainer&&(t.menuContainer.destroy(),t.menuContainer=null),t.gameOverContainer&&(t.gameOverContainer.destroy(),t.gameOverContainer=null),t.aimingLine&&t.aimingLine.clear(),P.reset(),d.log("üßπ Resources cleaned up")}catch(e){d.error("‚ùå Error during cleanup:",e)}}function Q(e){try{switch(e){case s.MENU:be.call(this);break;case s.PLAYING:this.tweens&&this.tweens.pauseAll();break;case s.GAME_OVER:we.call(this);break;case s.LEVEL_COMPLETE:xe.call(this);break;case s.PAUSED:this.tweens&&this.tweens.resumeAll();break}j.call(this)}catch(n){d.error(`‚ùå Error exiting state ${e}:`,n)}}function B(e,n){switch(e){case s.MENU:me.call(this);break;case s.PLAYING:Pe.call(this,n);break;case s.PAUSED:Se.call(this);break;case s.GAME_OVER:t.score>0&&Be(t.score,t.level),pe.call(this,n);break;case s.LEVEL_COMPLETE:ye.call(this,n);break}Ie.call(this)}function T(){t.grid=[];for(let e=0;e<y;e++){t.grid[e]=[];for(let n=0;n<p;n++)t.grid[e][n]=null}U.call(this)}const k=60,D=60;function Y(e,n){const i=n%2*m,o=k+e*m*2+i,a=D+n*m*1.7;return{x:o,y:a}}function K(e,n){const i=Math.round((n-D)/(m*1.7)),o=i%2*m,a=Math.round((e-k-o)/(m*2)),r=Math.max(0,Math.min(p-1,a)),u=Math.max(0,Math.min(y-1,i));return{col:r,row:u}}function U(){const e=[["red","blue","red","blue","red","blue","red","blue"],["blue","green","blue","green","blue","green","blue"],["green","yellow","green","yellow","green","yellow","green","yellow"],["yellow","purple","yellow","purple","yellow","purple","yellow"],["purple","red","purple","red","purple","red","purple","red"]];for(let n=0;n<e.length;n++)for(let i=0;i<e[n].length;i++)if(e[n][i]&&i<p){const o=e[n][i],a=Y(i,n),r=this.physics.add.sprite(a.x,a.y,o+"_bubble");r.setCircle(m),r.setImmovable(!0),r.color=o,r.setDepth(20),r.gridCol=i,r.gridRow=n,t.bubbleGroup.add(r),t.grid[n][i]=r}}function Z(){const e=h.width/2,n=h.height-60;t.launcher=this.add.container(e,n),t.launcher.setDepth(10);const i=this.add.rectangle(0,20,90,30,4473924);i.setStrokeStyle(3,2236962),t.launcher.add(i);const o=this.add.rectangle(-30,35,15,20,3355443);o.setStrokeStyle(2,1118481);const a=this.add.rectangle(30,35,15,20,3355443);a.setStrokeStyle(2,1118481),t.launcher.add([o,a]);const r=this.add.rectangle(0,15,70,8,5592405);r.setStrokeStyle(1,3355443),t.launcher.add(r),t.cannonBarrel=this.add.rectangle(0,-5,70,18,5592405),t.cannonBarrel.setStrokeStyle(2,3355443),t.cannonBarrel.setOrigin(.8,.5),t.launcher.add(t.cannonBarrel);const u=this.add.circle(-25,-5,12,2236962);u.setStrokeStyle(3,1118481),t.launcher.add(u);const l=this.add.rectangle(-10,-5,4,22,4473924),c=this.add.rectangle(5,-5,4,22,4473924);t.launcher.add([l,c]);const g=this.add.circle(15,-5,8,3355443);g.setStrokeStyle(2,1118481),t.launcher.add(g);const f=this.add.triangle(-35,-10,0,0,8,-12,0,-8,16739125),w=this.add.triangle(35,-10,0,0,-8,-12,0,-8,16739125);t.launcher.add([f,w]),t.cannonOriginalY=n,t.cannonBarrel=t.cannonBarrel,S.call(this),_.call(this)}function S(){t.currentBubble&&t.currentBubble.destroy();const e=t.nextBubble?t.nextBubble.color:z(),n=h.width/2,i=h.height-60;t.currentBubble=this.physics.add.sprite(n,i-40,e+"_bubble"),t.currentBubble.setCircle(m),t.currentBubble.color=e,t.currentBubble.setDepth(20),_.call(this)}function _(){t.nextBubble&&t.nextBubble.destroy();const e=z(),n=h.width-60,i=h.height-60;t.nextBubble=this.add.sprite(n,i,e+"_bubble"),t.nextBubble.setScale(.7),t.nextBubble.color=e,t.nextBubble.setDepth(20)}function ee(){this.input.on("pointerdown",te.bind(this)),this.input.on("pointermove",ne.bind(this)),this.input.on("pointerup",ie.bind(this)),this.input.addPointer(2),this.input.topOnly=!1}function te(e){switch(navigator.vibrate&&e.event&&e.event.touches&&navigator.vibrate(50),t.touchStartX=e.x,t.touchStartY=e.y,t.touchStartTime=Date.now(),t.currentState){case s.MENU:Ee.call(this,e.x,e.y);break;case s.PLAYING:t.currentBubble&&Ne.call(this,e.x,e.y);break;case s.PAUSED:Ce.call(this,e.x,e.y);break;case s.GAME_OVER:ve.call(this,e.x,e.y);break;case s.LEVEL_COMPLETE:Ge.call(this,e.x,e.y);break}}function ne(e){t.currentState!==s.PLAYING||!t.currentBubble||(Te.call(this,e.x,e.y),t.aimingLine&&X.call(this,e.x,e.y))}function ie(e){if(t.currentState!==s.PLAYING||!t.currentBubble)return;if(!t.canShoot){d.log("üö´ Shooting blocked - too soon after state change"),N.call(this);return}const n=Date.now()-t.touchStartTime,i=Phaser.Math.Distance.Between(t.touchStartX,t.touchStartY,e.x,e.y);n<200&&i<20?O.call(this,e.x,e.y):t.isAiming&&O.call(this,e.x,e.y),N.call(this)}function O(e,n){try{if(!ce(s.PLAYING)){d.warn("‚ö†Ô∏è Cannot shoot - invalid game state");return}if(!t.canShoot){d.warn("‚ö†Ô∏è Cannot shoot - shooting disabled");return}if(!t.currentBubble||!t.currentBubble.active){d.warn("‚ö†Ô∏è Cannot shoot - no current bubble");return}const i=se(e,n);if(e=i.x,n=i.y,t.lastShotTime&&Date.now()-t.lastShotTime<200){d.warn("‚ö†Ô∏è Shooting too fast - throttled");return}t.shotsFired++,t.lastShotTime=Date.now();const o=h.width/2,a=h.height-60,r=Phaser.Math.Angle.Between(o,a-40,e,n),u=300,l=Math.cos(r)*u,c=Math.sin(r)*u;if(isNaN(l)||isNaN(c)||Math.abs(l)>1e3||Math.abs(c)>1e3){d.error("‚ùå Invalid velocity calculated:",l,c);return}t.currentBubble.setVelocity(l,c),t.currentBubble.setBounce(.8,.8),t.currentBubble.setCollideWorldBounds(!0),t.currentBubble.setData("inFlight",!0),this.physics.add.overlap(t.currentBubble,t.bubbleGroup,(g,f)=>{g.getData("inFlight")&&(g.setData("inFlight",!1),oe.call(this,g,f))},null,this),this.physics.add.collider(t.currentBubble,this.physics.world.bounds,g=>{g.getData("inFlight")&&(g.setData("inFlight",!1),re.call(this,g))}),t.currentBubble=null,window.handleScoreUpdate&&window.handleScoreUpdate({event:"gameStats",score:t.score,level:t.level,shots:t.shotsFired}),this.time.delayedCall(500,()=>{S.call(this)})}catch(i){P.handleError(i,"shootBubble",()=>{S.call(this)})}}function oe(e,n){e.setVelocity(0,0),e.body.enable=!1;const i=ae(e,n),o=R(i.x,i.y);o?$(e,o.col,o.row):(d.warn("‚ö†Ô∏è No valid grid position found, destroying bubble"),e.destroy())}function re(e){e.setVelocity(0,0),e.body.enable=!1;const n=R(e.x,e.y);n?$(e,n.col,n.row):(d.warn("‚ö†Ô∏è No valid grid position found for wall collision, destroying bubble"),e.destroy())}function ae(e,n){const i=n.x-e.x,o=n.y-e.y,a=Math.sqrt(i*i+o*o),r=i/a,u=o/a,l=m*2,c=n.x-r*l,g=n.y-u*l;return{x:c,y:g}}function R(e,n){const i=K(e,n);return L(i.col,i.row)&&!t.grid[i.row][i.col]?i:le(i.col,i.row)}function le(e,n){const i=new Set,o=[{col:e,row:n,distance:0}];for(i.add(`${e},${n}`);o.length>0;){const{col:a,row:r,distance:u}=o.shift();if(L(a,r)&&!t.grid[r][a])return{col:a,row:r};if(u>=3)continue;const l=F(a,r);for(const c of l){const g=`${c.c},${c.r}`;i.has(g)||(i.add(g),o.push({col:c.c,row:c.r,distance:u+1}))}}return null}function F(e,n){return n%2===0?[{c:e-1,r:n},{c:e+1,r:n},{c:e-1,r:n-1},{c:e,r:n-1},{c:e-1,r:n+1},{c:e,r:n+1}]:[{c:e-1,r:n},{c:e+1,r:n},{c:e,r:n-1},{c:e+1,r:n-1},{c:e,r:n+1},{c:e+1,r:n+1}]}function $(e,n,i){const o=Y(n,i);e.setPosition(o.x,o.y),t.bubbleGroup.add(e),t.grid[i]&&(t.grid[i][n]={color:e.texture.key.replace("_bubble",""),sprite:e}),de.call(this,n,i)}function L(e,n){return n>=0&&n<y&&e>=0&&e<p}function se(e,n){const i=Math.max(0,Math.min(h.width,e)),o=Math.max(0,Math.min(h.height,n));return isNaN(i)||isNaN(o)?(d.warn("‚ö†Ô∏è Invalid input coordinates:",e,n),{x:h.width/2,y:h.height/2}):{x:i,y:o}}function ce(e=null){return t?e&&t.currentState!==e?(d.warn(`‚ö†Ô∏è Invalid state for operation. Required: ${e}, Current: ${t.currentState}`),!1):!t.grid||!Array.isArray(t.grid)?(d.error("‚ùå Grid is not properly initialized"),!1):!0:(d.error("‚ùå Game state is null"),!1)}function de(e,n){const i=t.grid[n][e];if(!i)return;let o;if(i.color)o=i.color;else if(i.texture&&i.texture.key)o=i.texture.key.replace("_bubble","");else return;const a=new Set,r=[];function u(l,c){const g=`${l},${c}`;if(a.has(g)||!t.grid[c]||!t.grid[c][l])return;const f=t.grid[c][l];let w;if(f.color)w=f.color;else if(f.texture&&f.texture.key)w=f.texture.key.replace("_bubble","");else return;if(w!==o)return;a.add(g),r.push({col:l,row:c});const x=c%2===0;let E;x?E=[{c:l-1,r:c},{c:l+1,r:c},{c:l-1,r:c-1},{c:l,r:c-1},{c:l-1,r:c+1},{c:l,r:c+1}]:E=[{c:l-1,r:c},{c:l+1,r:c},{c:l,r:c-1},{c:l+1,r:c-1},{c:l,r:c+1},{c:l+1,r:c+1}],E.forEach(({c:v,r:C})=>{v>=0&&v<p&&C>=0&&C<y&&u(v,C)})}u(e,n),r.length>=3&&(r.forEach(({col:l,row:c})=>{if(t.grid[c]&&t.grid[c][l]){const g=t.grid[c][l];let f=null;g.sprite?f=g.sprite:g.destroy&&(f=g),f&&f.x!==void 0&&f.y!==void 0&&ge.call(this,f.x,f.y,f),f&&f.destroy&&typeof f.destroy=="function"&&this.time.delayedCall(150,()=>{f.active&&f.destroy()}),t.grid[c][l]=null}}),I(r.length*10),he.call(this))}function ue(){const e=new Set,n=[];for(let i=0;i<p;i++)if(t.grid[0]&&t.grid[0][i]){const o=`${i},0`;e.add(o),n.push({col:i,row:0})}for(;n.length>0;){const{col:i,row:o}=n.shift(),a=F(i,o);for(const r of a){const{c:u,r:l}=r,c=`${u},${l}`;e.has(c)||L(u,l)&&(!t.grid[l]||!t.grid[l][u]||(e.add(c),n.push({col:u,row:l})))}}return e}function he(){const e=ue(),n=[];for(let i=0;i<y;i++)if(t.grid[i]){for(let o=0;o<p;o++)if(t.grid[i][o]){const a=`${o},${i}`;e.has(a)||n.push({col:o,row:i})}}n.length>0&&(d.log(`üíß Dropping ${n.length} floating bubble(s)`),n.forEach(({col:i,row:o})=>{const a=t.grid[o][i];if(!a)return;let r=null;a.sprite?r=a.sprite:a.destroy&&(r=a),r&&r.destroy&&typeof r.destroy=="function"&&(t.bubbleGroup&&t.bubbleGroup.contains(r)&&t.bubbleGroup.remove(r),this.tweens.add({targets:r,y:h.height+100,angle:Math.random()*360,alpha:.5,duration:800+Math.random()*400,ease:"Quad.easeIn",onComplete:()=>{r.active&&r.destroy()}})),t.grid[o][i]=null}),I(n.length*20))}function ge(e,n,i){let o=16777215;if(i.texture&&i.texture.key){const l=i.texture.key.replace("_bubble","");o=V(l)}this.tweens.add({targets:i,scaleX:1.3,scaleY:1.3,alpha:0,duration:150,ease:"Power2"});const a=8;for(let l=0;l<a;l++){const c=l/a*Math.PI*2,g=30+Math.random()*20,f=e+Math.cos(c)*g,w=n+Math.sin(c)*g,x=this.add.circle(e,n,3+Math.random()*3,o,.8);this.tweens.add({targets:x,x:f,y:w,alpha:0,scaleX:.5,scaleY:.5,duration:200+Math.random()*100,ease:"Power2",onComplete:()=>x.destroy()})}const r=this.add.circle(e,n,m,16777215,.6);this.tweens.add({targets:r,scaleX:1.5,scaleY:1.5,alpha:0,duration:150,ease:"Power2",onComplete:()=>r.destroy()});const u=this.add.text(e,n,"+10",{fontSize:"16px",fill:"#ffff00",fontFamily:"Arial",fontStyle:"bold",stroke:"#000000",strokeThickness:3}).setOrigin(.5);this.tweens.add({targets:u,y:n-30,alpha:0,duration:400,ease:"Power2",onComplete:()=>u.destroy()})}function fe(e){const n=this.add.graphics(),i=m,o=V(e);n.fillStyle(o,1),n.fillEllipse(i,i-2,i*2,i*2.1),n.fillStyle(16777215,.1),n.fillEllipse(i-4,i-5,4,6);const a=i*2+4,r=i*2+4;n.generateTexture(e+"_bubble",a,r),n.destroy()}function me(){if(t.menuContainer){t.menuContainer.setVisible(!0);return}t.menuContainer=this.add.container(h.width/2,h.height/2);const e=this.add.rectangle(0,0,h.width-40,h.height-100,0,.8);e.setStrokeStyle(2,9268835);const n=this.add.container(0,-100),i=this.add.image(0,0,"splash-logo"),o=h.width*.8,a=200,r=o/i.width,u=a/i.height,l=Math.min(r,u,1);i.setScale(l),n.add(i);const c=this.add.text(0,80,"Shoot cannons, pop balloons.",{fontSize:"18px",fill:"#f5f1e8",fontFamily:"Arial",fontStyle:"italic",align:"center"}).setOrigin(.5),g=this.add.text(0,110,"Match 3+ to clear ‚Ä¢ Clear all to win!",{fontSize:"13px",fill:"#d5d1c8",fontFamily:"Arial",align:"center"}).setOrigin(.5),f=this.add.rectangle(0,160,200,50,9268835);f.setStrokeStyle(2,16118248),f.setInteractive({useHandCursor:!0});const w=this.add.text(0,160,"Start Game",{fontSize:"18px",fill:"#f5f1e8",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5);t.menuContainer.add([e,n,c,g,f,w]),f.buttonType="start"}function be(){t.menuContainer&&t.menuContainer.setVisible(!1)}function pe(e){if(t.gameOverContainer){t.gameOverContainer.setVisible(!0);return}t.gameOverContainer=this.add.container(h.width/2,h.height/2);const n=this.add.rectangle(0,0,h.width-40,h.height-100,0,.9);n.setStrokeStyle(2,16729156);const i=this.add.text(0,-120,"üí• Game Over",{fontSize:"28px",fill:"#ff4444",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5),o=this.add.text(0,-70,`Final Score: ${t.score.toLocaleString()}`,{fontSize:"18px",fill:"#f5f1e8",fontFamily:"Arial"}).setOrigin(.5),a=this.add.text(0,-40,`Level Reached: ${t.level}`,{fontSize:"16px",fill:"#8d6e63",fontFamily:"Arial"}).setOrigin(.5),r=this.add.rectangle(0,20,180,45,9268835);r.setStrokeStyle(2,16118248),r.setInteractive({useHandCursor:!0});const u=this.add.text(0,20,"Play Again",{fontSize:"16px",fill:"#f5f1e8",fontFamily:"Arial",fontStyle:"bold"}).setOrigin(.5),l=this.add.rectangle(0,80,140,40,6114933);l.setStrokeStyle(2,16118248),l.setInteractive({useHandCursor:!0});const c=this.add.text(0,80,"Main Menu",{fontSize:"14px",fill:"#f5f1e8",fontFamily:"Arial"}).setOrigin(.5);t.gameOverContainer.add([n,i,o,a,r,u,l,c]),r.buttonType="restart",l.buttonType="menu"}function we(){t.gameOverContainer&&t.gameOverContainer.setVisible(!1)}function ye(e){}function xe(){t.levelCompleteContainer&&t.levelCompleteContainer.setVisible(!1)}function Se(){}function Ee(e,n){if(t.menuContainer&&t.menuContainer.visible){const i=h.width/2,a=h.height/2+150;e>=i-100&&e<=i+100&&n>=a-25&&n<=a+25&&b.call(this,s.PLAYING)}}function ve(e,n){if(t.gameOverContainer&&t.gameOverContainer.visible){const i=h.width/2,o=h.height/2,a=o+20;if(e>=i-90&&e<=i+90&&n>=a-22&&n<=a+22){b.call(this,s.PLAYING);return}const r=o+80;if(e>=i-70&&e<=i+70&&n>=r-20&&n<=r+20){b.call(this,s.MENU);return}}}function Ce(e,n){b.call(this,s.PLAYING)}function Ge(e,n){}function Me(){let e=0;for(let n=0;n<y;n++)for(let i=0;i<p;i++)t.grid[n][i]&&e++;if(e===0){const n=Math.max(0,t.shotsUntilCeilingDrop*100),i=Math.max(0,Math.floor((6e4-(Date.now()-t.startTime))/1e3)*10);I(n+i),b.call(this,s.LEVEL_COMPLETE,{bonusPoints:n,timeBonus:i,totalScore:t.score,nextLevel:t.level+1})}}function Ae(){const e=y-2;for(let n=0;n<p;n++)if(t.grid[e]&&t.grid[e][n]){b.call(this,s.GAME_OVER,{reason:"Bubbles reached the bottom",finalScore:t.score,level:t.level});return}}function Pe(e){(!e||e.restart)&&(t.score=0,t.level=1,t.shotsFired=0,t.shotsUntilCeilingDrop=6,t.ceilingRow=0,t.startTime=Date.now(),Le.call(this),T.call(this),U.call(this)),t.currentBubble||S.call(this),d.log("üéÆ Gameplay started!")}function Le(){t.bubbleGroup&&t.bubbleGroup.clear(!0,!0);for(let e=0;e<y;e++)for(let n=0;n<p;n++)t.grid[e][n]=null}function Ie(){t.stateText&&t.stateText.setText(`State: ${t.currentState}`)}function I(e){t.score+=e;const n=parseInt(localStorage.getItem("cannonpop_high_score")||"0");t.score>n&&(localStorage.setItem("cannonpop_high_score",t.score.toString()),window.handleScoreUpdate&&window.handleScoreUpdate({event:"newHighScore",score:t.score,previousHigh:n})),window.handleScoreUpdate&&window.handleScoreUpdate({event:"gameStats",score:t.score,level:t.level,shots:t.shotsFired})}function Be(e,n){try{const i=Oe(),o={score:e,level:n,date:new Date().toISOString(),timestamp:Date.now()};i.push(o),i.sort((r,u)=>u.score-r.score);const a=i.slice(0,10);return localStorage.setItem("cannonpop_high_scores",JSON.stringify(a)),d.log(`üèÜ High score saved: ${e.toLocaleString()}`),a}catch(i){return d.error("‚ùå Failed to save high score:",i),[]}}function Oe(){try{const e=localStorage.getItem("cannonpop_high_scores");return e?JSON.parse(e):[]}catch(e){return d.error("‚ùå Failed to load high scores:",e),[]}}function z(){return A[Math.floor(Math.random()*A.length)]}function V(e){return{blue:1263238,red:15548199,yellow:16691738,cream:16643299,green:4504388,purple:12272827}[e]||16777215}function Ne(e,n){t.isAiming=!0,X.call(this,e,n)}function N(){t.isAiming=!1,t.aimingLine&&t.aimingLine.clear()}function Te(e,n){if(!t.currentBubble)return;const i=h.width/2,o=h.height-60;let a=Phaser.Math.Angle.Between(i,o-40,e,n);const r=Math.PI*.8,u=Math.PI*.2;a>r&&(a=r),a<u&&(a=u),t.currentAimAngle=a}function X(e,n){if(!t.aimingLine)return;const i=h.width/2,o=h.height-60;t.aimingLine.clear(),t.aimingLine.lineStyle(3,16777215,.7);const a=150,r=i+Math.cos(t.currentAimAngle)*a,u=o+Math.sin(t.currentAimAngle)*a;t.aimingLine.moveTo(i,o-40),t.aimingLine.lineTo(r,u);for(let l=1;l<=5;l++){const c=i+Math.cos(t.currentAimAngle)*(a*l/5),g=o+Math.sin(t.currentAimAngle)*(a*l/5);t.aimingLine.fillStyle(16777215,.5),t.aimingLine.fillCircle(c,g,2)}}function ke(){}window.initializeCannonPopGame=function(){if(window.gameInstance){d.log("üéÆ Game already initialized");return}if(d.log("üöÄ Manual game initialization triggered"),document.readyState!=="loading"){d.log("üéØ Initializing Mobile-Optimized Phaser game..."),d.log("üîç DOM loaded, Phaser available:",typeof Phaser<"u"),d.log("üîç Game container exists:",!!document.getElementById("game-container"));const e=document.querySelector(".loading");e&&(d.log("üîç Removing loading message"),e.style.display="none");try{d.log("üîç Creating Phaser game with config:",h),M=new Phaser.Game(h),window.gameInstance=M,d.log("‚úÖ Mobile-optimized Phaser game created successfully"),M.events.on("ready",()=>{d.log("üéÆ Phaser game is ready and running!")})}catch(n){d.error("‚ùå Error creating Phaser game:",n);const i=document.getElementById("game-container");i&&(i.innerHTML=`
                    <div style="color: #f5f1e8; text-align: center; padding: 20px;">
                        <h3>Game Loading Error</h3>
                        <p>Failed to initialize the game engine.</p>
                        <p style="font-size: 12px; opacity: 0.7;">Check console for details.</p>
                    </div>
                `)}}};document.addEventListener("DOMContentLoaded",()=>{d.log("üéØ DOM loaded - calling manual initialization..."),window.initializeCannonPopGame()});window.gameState=t;window.GAME_CONFIG=h;window.restartGame=function(){if(d.log("üîÑ Restart game requested"),window.gameInstance&&window.gameInstance.scene.scenes[0]){const e=window.gameInstance.scene.scenes[0];b.call(e,s.PLAYING,{restart:!0}),d.log("‚úÖ Game restarted")}};window.pauseGame=function(){if(d.log("‚è∏Ô∏è Pause game requested"),window.gameInstance&&window.gameInstance.scene.scenes[0]){const e=window.gameInstance.scene.scenes[0];b.call(e,s.PAUSED),d.log("‚úÖ Game paused")}};window.resumeGame=function(){if(d.log("‚ñ∂Ô∏è Resume game requested"),window.gameInstance&&window.gameInstance.scene.scenes[0]){const e=window.gameInstance.scene.scenes[0];b.call(e,s.PLAYING),d.log("‚úÖ Game resumed")}};
